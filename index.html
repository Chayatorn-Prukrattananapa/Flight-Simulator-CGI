<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plane Game</title>
    <style>
        html,
        body {
            margin: 0;
            height: 100%;
        }

        #c {
            width: 100%;
            height: 100%;
            display: block;
        }
    </style>
</head>

<body>
    <canvas id="c"></canvas>

    <script type="module">
        import * as THREE from "https://threejsfundamentals.org/threejs/resources/threejs/r132/build/three.module.js";
        import { OrbitControls } from "https://threejsfundamentals.org/threejs/resources/threejs/r132/examples/jsm/controls/OrbitControls.js";
        import { GLTFLoader } from "https://threejsfundamentals.org/threejs/resources/threejs/r132/examples/jsm/loaders/GLTFLoader.js";

        function main() {

            const cubeTextureLoader = new THREE.CubeTextureLoader();
            const cubeMapTexture = cubeTextureLoader.load([
                    './src/sky5.png', './src/sky1.png',
                    './src/sky3.png', './src/sky6.png',
                    './src/sky4.png', './src/sky2.png'
                ]);

            // Set up scene
            const scene = new THREE.Scene();
            scene.background = cubeMapTexture;

            // Set up camera
            const camera = new THREE.PerspectiveCamera(
                45,
                window.innerWidth / window.innerHeight,
                0.1,
                1000
            );
            camera.lookAt(scene.position);
            camera.position.set(0, 50, -30);


            // Set up renderer
            const canvas = document.querySelector("#c");
            const renderer = new THREE.WebGLRenderer({ canvas });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor('lightblue');
            renderer.shadowMap.enabled = true; // Enable shadows

            // Set up lighting
            const light = new THREE.HemisphereLight(0xffffff, 0x444444);
          //  light.castShadow = true;
            scene.add(light);


            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0); // Adjust the intensity as needed
                    directionalLight.position.set(15, 20, 10); // Set the position of the directional light
                    directionalLight.castShadow = true; // Set this light to cast shadows
                    scene.add(directionalLight);

            var ambientLight = new THREE.AmbientLight( 0xffffff, 0.15 );
                    scene.add( ambientLight );

            // Load model
            let planeModel;
            let townModel;

            const pivot = new THREE.Group();
            scene.add(pivot);

            const loader = new GLTFLoader();
            loader.load('src/911.gltf', (gltf) => {
                planeModel = gltf.scene;
                planeModel.castShadow = true;
                planeModel.receiveShadow = true;
                scene.add(planeModel);
            });

            loader.load('src/town1.0.gltf', (gltf) => {
                townModel = gltf.scene;
                townModel.position.y += -80;
                townModel.traverse((child) => {
                    if (child.isMesh) {
                        child.castShadow = true;
                        child.receiveShadow = true;
                    }
                });
                pivot.add(townModel);
            });

            // Set up controls
            const controls = new OrbitControls(camera, renderer.domElement);
            controls.target.set(0, 10, 0);
            controls.update();

            // Animation loop
            function animate() {
                requestAnimationFrame(animate);

                updatePlanePosition()

                controls.update();
                renderer.render(scene, camera);
            }

            // Movement speed
            const movementSpeed = 1;
            const rotationSpeed = 0.5;

            // Add variables to store the key states
            const keys = { W: false, A: false, S: false, D: false };

            // Add event listeners for keydown and keyup events
            document.addEventListener('keydown', handleKeyDown);
            document.addEventListener('keyup', handleKeyUp);

            function handleKeyDown(event) {
                handleKeyEvent(event, true);
            }

            function handleKeyUp(event) {
                handleKeyEvent(event, false);
            }

            function handleKeyEvent(event, value) {
                const key = event.key.toUpperCase();
                if (key in keys) {
                    keys[key] = value;
                }
            }

            function updatePlanePosition() {
                if (keys.W) {
                    townModel.position.z += movementSpeed * -1;
                }
                if (keys.A) {
                    pivot.rotation.y -= Math.PI / 180 * rotationSpeed;
                }
                if (keys.S) {
                    townModel.position.z -= movementSpeed * -1;
                }
                if (keys.D) {
                    pivot.rotation.y += Math.PI / 180 * rotationSpeed;
                }
            }

            animate();

            // Handle window resize
            window.addEventListener("resize", () => {
                const newWidth = window.innerWidth;
                const newHeight = window.innerHeight;

                camera.aspect = newWidth / newHeight;
                camera.updateProjectionMatrix();

                renderer.setSize(newWidth, newHeight);
            });
        }

        main();

    </script>
</body>

</html>